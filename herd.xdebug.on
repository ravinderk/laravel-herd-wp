#!/bin/bash

# --- Xdebug Enable Script for Laravel Herd ---
# This script enables Xdebug for debugging WordPress sites in Herd
#
# Date: January 2025

echo "🐛 --- Enabling Xdebug for Laravel Herd --- 🐛"
echo "This script will enable Xdebug for debugging."
echo "----------------------------------------------------"

# --- Function to check if a command exists ---
command_exists () {
  type "$1" &> /dev/null ;
}

# --- 1. Check for Herd ---
echo "🔍 Checking for Herd..."
if ! command_exists herd ; then
  echo "❌ Error: Herd is not found. Please install Herd (https://herd.laravel.com/) and ensure it's in your system's PATH."
  exit 1
fi
echo "✅ Herd found."

# --- 2. Enable Xdebug ---
echo "🔧 Enabling Xdebug..."

# Define Herd PHP config directory
HERD_PHP_CONFIG_DIR="$HOME/Library/Application Support/Herd/config/php"

if [ ! -d "$HERD_PHP_CONFIG_DIR" ]; then
    echo "❌ Error: Herd PHP config directory not found at $HERD_PHP_CONFIG_DIR"
    exit 1
fi

echo "📁 Found Herd PHP config directory: $HERD_PHP_CONFIG_DIR"

# Configure xdebug.mode in all PHP versions
echo "⚙️ Configuring Xdebug mode in all PHP versions..."

for php_version_dir in "$HERD_PHP_CONFIG_DIR"/*; do
    if [ -d "$php_version_dir" ]; then
        PHP_VERSION=$(basename "$php_version_dir")
        PHP_INI_FILE="$php_version_dir/php.ini"
        
        if [ -f "$PHP_INI_FILE" ]; then
            echo "🔧 Checking PHP $PHP_VERSION: $PHP_INI_FILE"
            
            # Check if Xdebug is configured in this PHP version
            if grep -q "xdebug" "$PHP_INI_FILE"; then
                # Check if xdebug.mode exists and update/add it
                if grep -q "^xdebug.mode" "$PHP_INI_FILE"; then
                    # Update existing xdebug.mode
                    sed -i '' 's/^xdebug.mode.*/xdebug.mode=debug/' "$PHP_INI_FILE"
                    echo "✅ Updated xdebug.mode=debug in PHP $PHP_VERSION"
                else
                    # Add xdebug.mode if it doesn't exist
                    echo "xdebug.mode=debug" >> "$PHP_INI_FILE"
                    echo "✅ Added xdebug.mode=debug to PHP $PHP_VERSION"
                fi
            else
                echo "⏭️ Skipping PHP $PHP_VERSION - Xdebug not configured in php.ini"
            fi
        else
            echo "⚠️ Warning: php.ini not found for PHP $PHP_VERSION"
        fi
    fi
done

echo "✅ Xdebug enabled and configured successfully!"

# Restart Herd to apply changes
echo "🔄 Restarting Herd to apply Xdebug configuration..."
herd restart
if [ $? -eq 0 ]; then
    echo "✅ Herd restarted successfully!"
else
    echo "⚠️ Warning: Failed to restart Herd. You may need to restart manually."
fi

echo "🎯 Happy Debugging!"
